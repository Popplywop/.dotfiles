#!/usr/bin/env bash
# Bitwarden userscript for qutebrowser
# Presents a rofi/dmenu picker to select credentials, then fills the form

set -euo pipefail

# =============================================================================
# Configuration
# =============================================================================
PICKER_CMD="rofi -dmenu -i -p Bitwarden"

# =============================================================================
# Helper Functions
# =============================================================================
notify() {
    notify-send -a "qutebrowser" "Bitwarden" "$1"
}

error() {
    notify "Error: $1"
    echo "message-error 'Bitwarden: $1'" >> "$QUTE_FIFO"
    exit 1
}

info() {
    echo "message-info 'Bitwarden: $1'" >> "$QUTE_FIFO"
}

# Get domain from URL
get_domain() {
    echo "$1" | sed -E 's|https?://([^/]+).*|\1|' | sed 's/^www\.//'
}

# =============================================================================
# Main Logic
# =============================================================================
main() {
    # Ensure we have the required environment
    [[ -z "${QUTE_URL:-}" ]] && error "Not running as qutebrowser userscript"
    [[ -z "${QUTE_FIFO:-}" ]] && error "QUTE_FIFO not set"

    # Check dependencies
    command -v bw &>/dev/null || error "Bitwarden CLI (bw) not installed"
    command -v jq &>/dev/null || error "jq not installed"
    command -v rofi &>/dev/null || error "rofi not installed"

    # Check if logged in
    local status
    status=$(bw status 2>/dev/null | jq -r '.status' 2>/dev/null || echo "error")

    if [[ "$status" == "unauthenticated" ]]; then
        error "Not logged in. Run 'bw login' first."
    fi

    # Always prompt for master password
    local password
    password=$(rofi -dmenu -password -p "Password" -mesg "ðŸ” Enter Bitwarden Master Password" -lines 0 -width 400) || exit 0

    if [[ -z "$password" ]]; then
        exit 0
    fi

    # Unlock vault and get session
    local session
    session=$(bw unlock --raw "$password" 2>&1)

    if [[ -z "$session" || "$session" == *"Invalid"* || "$session" == *"error"* ]]; then
        error "Failed to unlock vault"
    fi

    # Get domain for search
    local domain
    domain=$(get_domain "$QUTE_URL")
    info "Searching for $domain..."

    # Search for matching credentials
    local items
    items=$(BW_SESSION="$session" bw list items --search "$domain" 2>/dev/null)

    if [[ -z "$items" || "$items" == "[]" ]]; then
        error "No credentials found for $domain"
    fi

    # Filter to only login items
    local logins
    logins=$(echo "$items" | jq '[.[] | select(.type == 1) | select(.login)]')

    local count
    count=$(echo "$logins" | jq 'length')

    if [[ "$count" -eq 0 ]]; then
        error "No login credentials found for $domain"
    fi

    # Build picker menu: "username (name)"
    local menu
    menu=$(echo "$logins" | jq -r '.[] | "\(.login.username) (\(.name))"')

    # Show picker for credential selection
    local selection
    selection=$(echo "$menu" | $PICKER_CMD) || exit 0

    if [[ -z "$selection" ]]; then
        exit 0
    fi

    # Find the selected item index
    local index=0
    while IFS= read -r line; do
        if [[ "$line" == "$selection" ]]; then
            break
        fi
        ((index++))
    done <<< "$menu"

    # Extract credentials for selected item
    local username password_val
    username=$(echo "$logins" | jq -r ".[$index].login.username // empty")
    password_val=$(echo "$logins" | jq -r ".[$index].login.password // empty")

    if [[ -z "$username" || -z "$password_val" ]]; then
        error "Failed to extract credentials"
    fi

    # Escape special characters for JavaScript (single quotes)
    username_escaped=$(printf '%s' "$username" | sed "s/\\\\/\\\\\\\\/g; s/'/\\\\'/g")
    password_escaped=$(printf '%s' "$password_val" | sed "s/\\\\/\\\\\\\\/g; s/'/\\\\'/g")

    # Fill the form using JavaScript (must be single line for qutebrowser FIFO)
    local js_code="(function() { var u='${username_escaped}'; var p='${password_escaped}'; var uf=document.querySelector('input[type=\"email\"], input[type=\"text\"][name*=\"user\"], input[type=\"text\"][name*=\"email\"], input[name=\"username\"], input[name=\"email\"]'); var pf=document.querySelector('input[type=\"password\"]'); if(uf){uf.focus();uf.value=u;uf.dispatchEvent(new Event('input',{bubbles:true}));uf.dispatchEvent(new Event('change',{bubbles:true}));} if(pf){pf.focus();pf.value=p;pf.dispatchEvent(new Event('input',{bubbles:true}));pf.dispatchEvent(new Event('change',{bubbles:true}));} if(!uf&&!pf){alert('Bitwarden: Could not find login fields');} })();"

    echo "jseval -q ${js_code}" >> "$QUTE_FIFO"

    info "Filled credentials for ${username}"
}

main "$@"
